name: Auto Label Issues (Models)

on:
  issues:
    types: [opened]

permissions:
  issues: write
  models: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  auto-label:
    if: ${{ github.repository == 'meshtastic/firmware' && github.event.issue.user.type != 'Bot' && !contains(github.event.issue.labels.*.name, 'automation') }}
    runs-on: ubuntu-latest
    steps:
      - name: Classify issue for labeling
        uses: actions/ai-inference@v2
        id: ai
        continue-on-error: true
        with:
          max-tokens: 30
          prompt: |
            Decide if this issue should be auto-labeled.

            Return exactly one of: needs-logs, needs-info, ok

            Use needs-logs only if this looks like a device/firmware bug report (crash/reboot/lockup/radio/GPS/display/power/sleep/etc) AND there are no device logs/serial console output included.

            Use needs-info only if it is missing key basics like steps to reproduce and firmware version.

            Otherwise return ok.

            Title: ${{ github.event.issue.title }}
            Body: ${{ github.event.issue.body }}
          system-prompt: You are a conservative GitHub issue triage assistant. Only apply needs-logs/needs-info when clearly warranted.
          model: openai/gpt-4o-mini

      - name: Normalize label decision
        if: steps.ai.outputs.response != ''
        uses: actions/github-script@v8
        id: normalize
        env:
          AI_RESPONSE: ${{ steps.ai.outputs.response }}
        with:
          script: |
            const raw = (process.env.AI_RESPONSE || '').trim().toLowerCase();
            const allowed = new Set(['needs-logs', 'needs-info', 'ok']);
            const label = allowed.has(raw) ? raw : 'ok';
            core.setOutput('label', label);

      - name: Ensure label exists
        if: steps.normalize.outputs.label != '' && steps.normalize.outputs.label != 'ok'
        uses: actions/github-script@v8
        env:
          LABEL_NAME: ${{ steps.normalize.outputs.label }}
        with:
          script: |
            const label = process.env.LABEL_NAME;
            const labelMeta = {
              'needs-logs': { color: 'cfd3d7', description: 'Device logs requested for triage' },
              'needs-info': { color: 'f9d0c4', description: 'More information requested for triage' },
            };
            const meta = labelMeta[label];
            if (!meta) return;

            try {
              await github.rest.issues.getLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: label,
              });
            } catch (e) {
              if (e.status !== 404) throw e;
              await github.rest.issues.createLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: label,
                color: meta.color,
                description: meta.description,
              });
            }

      - name: Apply label
        if: steps.normalize.outputs.label != '' && steps.normalize.outputs.label != 'ok'
        uses: actions/github-script@v8
        env:
          LABEL_NAME: ${{ steps.normalize.outputs.label }}
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              labels: [process.env.LABEL_NAME],
            });
