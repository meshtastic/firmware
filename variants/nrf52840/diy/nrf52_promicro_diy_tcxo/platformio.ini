; Promicro + E22(0)-xxxM / HT-RA62 modules board variant - DIY - with TCXO
; FAKETEC/FAKEDECK - MESHCHATSTIC OPTIMIZADO POR DEFECTO
; Esta configuración está optimizada para compilar correctamente con MeshChatstic
; en dispositivos nRF52840 (~800KB Flash) sin errores de memoria
[env:nrf52_promicro_diy_tcxo]
extends = nrf52840_base
board = promicro-nrf52840
build_flags = 
  ${nrf52840_base.build_flags}
  -I variants/nrf52840/diy/nrf52_promicro_diy_tcxo
  -D NRF52_PROMICRO_DIY
  ; ====== OPTIMIZACIONES PARA COMPILACIÓN EXITOSA ======
  ; Multi-language fonts exclusions (saves ~22KB)
  -DEXCLUDE_PKG_GRAPHICS_FONT_MULTIIDIOMA_FIXED=1
  -DEXCLUDE_PKG_GRAPHICS_FONT_MULTIIDIOMA_16=1
  -DEXCLUDE_PKG_GRAPHICS_FONT_MULTIIDIOMA_18=1
  -DEXCLUDE_PKG_GRAPHICS_FONT_MULTIIDIOMA_26=1
  ; Core features exclusions for memory optimization
  -DMESHTASTIC_EXCLUDE_HTTP_WEBSERVER=1
  -DMESHTASTIC_EXCLUDE_WEBSERVER=1
  -DEXCLUDE_HTTP=1
  -DEXCLUDE_WEBSERVER=1
  ; Network exclusions (nRF52840 doesn't have WiFi anyway)
  -DMESHTASTIC_EXCLUDE_ETHERNET=1
  -DEXCLUDE_ETHERNET=1
  ; Motion sensor exclusions (keep I2C for cardKB)
  -DEXCLUDE_ACCELEROMETER=1
  -DMESHTASTIC_EXCLUDE_POWER_TELEMETRY=1
  -DEXCLUDE_POWER_TELEMETRY=1
  ; Essential module exclusions to fit in Flash
  -DMESHTASTIC_EXCLUDE_ENVIRONMENTAL_SENSOR=1
  -DMESHTASTIC_EXCLUDE_MQTT=1
  -DEXCLUDE_MQTT=1
  -DMESHTASTIC_EXCLUDE_RANGETEST=1
  -DMESHTASTIC_EXCLUDE_CANNEDMESSAGES=1
  -DMESHTASTIC_EXCLUDE_STOREFORWARD=1
  -DMESHTASTIC_EXCLUDE_PAXCOUNTER=1
  -DMESHTASTIC_EXCLUDE_ATAK=1
  -DMESHTASTIC_EXCLUDE_NEIGHBORINFO=1
  -DMESHTASTIC_EXCLUDE_DETECTION_SENSOR=1
  -DMESHTASTIC_EXCLUDE_HEALTH=1
  -DMESHTASTIC_EXCLUDE_TRACEROUTE=1
  ; Audio exclusions (not available on fakeTec hardware)
  -DMESHTASTIC_EXCLUDE_AUDIO=1
  -DEXCLUDE_AUDIO=1
  -DEXCLUDE_RTTTL=1
  ; Force linking to StubDefinitions
  -Wl,--undefined=accelerometerThread
build_src_filter = 
  ${nrf52_base.build_src_filter} 
  +<../variants/nrf52840/diy/nrf52_promicro_diy_tcxo>
  -<src/platform/esp32/>
  -<src/nimble/>
  +<../variants/nrf52840/diy/nrf52_promicro_diy_tcxo/StubDefinitions.cpp>
lib_deps = 
  ${nrf52840_base.lib_deps}
lib_ignore = 
  WiFi
  WebServer
  ESPAsyncWebServer
  DNSServer
  Ethernet
  NimBLE-Arduino
  bsec2
  NonBlockingRTTTL
debug_tool = jlink

; NRF52 ProMicro w/ E-Ink display
[env:nrf52_promicro_diy-inkhud]
board_level = extra
extends = nrf52840_base, inkhud
board = promicro-nrf52840
build_flags =
  ${nrf52840_base.build_flags}
  ${inkhud.build_flags}
  -I variants/nrf52840/diy/nrf52_promicro_diy_tcxo
  -D NRF52_PROMICRO_DIY
build_src_filter =
  ${nrf52_base.build_src_filter}
  ${inkhud.build_src_filter}
  +<../variants/nrf52840/diy/nrf52_promicro_diy_tcxo>
lib_deps =
  ${inkhud.lib_deps} ; InkHUD libs first, so we get GFXRoot instead of AdafruitGFX
  ${nrf52840_base.lib_deps}
extra_scripts =
  ${env.extra_scripts}
  variants/nrf52840/diy/nrf52_promicro_diy_tcxo/custom_build_tasks.py ; Add to PIO's Project Tasks pane: preset builds for common displays

; ==========================================
; FAKETEC/FAKEDECK - VERSIÓN EXPERIMENTAL
; ==========================================
; Configuración con TODAS las funcionalidades de MeshChatstic (NO COMPILA)
; Solo para referencia - Use la versión principal arriba para uso normal

[env:nrf52_promicro_diy_tcxo_meshchatstic_experimental]
extends = nrf52840_base
board = promicro-nrf52840
build_flags = ${nrf52840_base.build_flags}
  -I variants/nrf52840/diy/nrf52_promicro_diy_tcxo
  -D NRF52_PROMICRO_DIY
  ; ====== HABILITAR TODAS LAS FUNCIONES MESHCHATSTIC ======
  -DMESHCHAT_ENABLED=1                    ; Sistema de chat completo
  -DCHAT_HISTORY_ENABLED=1               ; Historial de conversaciones
  -DVIRTUAL_KEYBOARD_ENABLED=1           ; Teclado virtual en pantalla
  -DFAV_NODE_CHAT_ENABLED=1              ; Chat con nodos favoritos
  -DCHANNEL_CHAT_TAB_ENABLED=1           ; Tabs de chat por canal
  -DUNREAD_COUNT_ENABLED=1               ; Contador de mensajes no leídos
  -DCHAT_PERSISTENCE_ENABLED=1           ; Persistencia de chat
  ; ====== OPTIMIZACIONES PARA nRF52840 (~800KB) ======
  -Os                                     ; Optimizar para tamaño
  -ffunction-sections                     ; Permitir eliminación de código
  -fdata-sections                         ; Permitir eliminación de datos
  -Wl,--gc-sections                       ; Eliminar código/datos no usados
  -fno-exceptions                         ; Deshabilitar excepciones C++
  -fno-rtti                              ; Deshabilitar RTTI
  -DCORE_DEBUG_LEVEL=0                   ; Sin debug output
  ; ====== CONFIGURACIONES DE MEMORIA ======
  -DSERIAL_BUFFER_SIZE=512               ; Buffer serial reducido
  -DMAX_RX_TOPHONE=16                    ; Reducir cola de mensajes
  -DMAX_RX_FROMRADIO=8                   ; Reducir cola de radio
  -DBLE_MAX_CONN=1                       ; Una sola conexión BLE
  ; ====== MANTENER FUNCIONES ESENCIALES ======
  ; Chat, Mesh básico, GPS, Sensores I2C, Bluetooth, LoRa
  ; ====== DESHABILITAR SOLO MÓDULOS NO ESENCIALES ======
  -DMESHTASTIC_EXCLUDE_RANGETEST=1       ; Sin test de rango
  -DMESHTASTIC_EXCLUDE_STOREFORWARD=1    ; Sin store & forward
  -DMESHTASTIC_EXCLUDE_DETECTIONSENSOR=1 ; Sin sensor de detección
  -DMESHTASTIC_EXCLUDE_EXTERNALNOTIFICATION=1 ; Sin notificaciones externas
  -DMESHTASTIC_EXCLUDE_POWER_TELEMETRY=1 ; Sin telemetría de energía
  ; Nota: Mantenemos sensores básicos, GPS, posición, telemetría de dispositivo

build_src_filter = ${nrf52_base.build_src_filter} +<../variants/nrf52840/diy/nrf52_promicro_diy_tcxo>
  ; Excluir solo módulos específicos para ahorrar espacio
  -<modules/RangeTestModule*>             ; No necesario para chat
  -<modules/StoreForwardModule*>          ; No necesario para chat
  ; MANTENER: ChatHistoryStore, VirtualKeyboard, todos los frames de chat
  ; MANTENER: TextMessageModule, PositionModule, NodeInfoModule
  ; MANTENER: Todos los sensores básicos y telemetría de dispositivo
  
lib_deps = 
  ${nrf52840_base.lib_deps}
debug_tool = jlink

; Configuración ultra-compacta para casos donde el espacio es crítico (NO COMPILA)
[env:nrf52_promicro_diy_tcxo_meshchatstic_lite_experimental]
extends = nrf52840_base
board = promicro-nrf52840
build_flags = 
    ${nrf52840_base.build_flags}
    -I variants/nrf52840/diy/nrf52_promicro_diy_tcxo
    -D NRF52_PROMICRO_DIY
    -D MESHCHATSTIC_ENABLED=1
    -D HAS_SCREEN=1
    -D USE_SSD1306=1
    -Os
    -D EXCLUDE_ATAK=1
    -D EXCLUDE_MQTT=1
    -D EXCLUDE_CANNEDMESSAGES=1
    -D EXCLUDE_RANGETEST=1
    -D EXCLUDE_DEVICETESTING=1
    -D EXCLUDE_TRACEROUTE=1
    -D EXCLUDE_AUDIO=1
    -D EXCLUDE_REMOTE_HARDWARE=1
    -D EXCLUDE_NEIGHBOR_INFO=1
    -D EXCLUDE_POWER_STRESS=1
    -D EXCLUDE_ENVIRONMENTAL_SENSOR=1
    -D EXCLUDE_EXTERNAL_NOTIFICATION=1
    -D EXCLUDE_DETECTION_SENSOR=1
    -D EXCLUDE_WAYPOINT_MODULE=1
    -D EXCLUDE_PAXCOUNTER=1
    -D DISABLE_ACCELEROMETER=1
    -D EXCLUDE_POWER_TELEMETRY=1
    -D HAS_I2C=0
    -D DISABLE_BMX160=1
    -D DISABLE_MPU6050=1
    -D DISABLE_LIS3DH=1
    -D DISABLE_LSM6DS3=1
    -D DISABLE_ICM20948=1
; ==========================================
; FAKETEC/FAKEDECK - VERSIÓN LEGADO
; ==========================================
; Configuración CRÍTICA original - Mantenida como respaldo
; Usar solo si necesitas comparar con la versión principal optimizada

[env:nrf52_promicro_diy_tcxo_meshchatstic_critical_legacy]
extends = env:nrf52_promicro_diy_tcxo
build_flags = 
  ${env:nrf52_promicro_diy_tcxo.build_flags}
  ; Force linking to StubDefinitions
  -Wl,--undefined=accelerometerThread
  ; Multi-language fonts exclusions (saves ~22KB)
  -DEXCLUDE_PKG_GRAPHICS_FONT_MULTIIDIOMA_FIXED=1
  -DEXCLUDE_PKG_GRAPHICS_FONT_MULTIIDIOMA_16=1
  -DEXCLUDE_PKG_GRAPHICS_FONT_MULTIIDIOMA_18=1
  -DEXCLUDE_PKG_GRAPHICS_FONT_MULTIIDIOMA_26=1
  ; Core features exclusions
  -DMESHTASTIC_EXCLUDE_HTTP_WEBSERVER=1
  -DMESHTASTIC_EXCLUDE_WEBSERVER=1
  -DEXCLUDE_HTTP=1
  -DEXCLUDE_WEBSERVER=1
  ; Network exclusions
  -DMESHTASTIC_EXCLUDE_ETHERNET=1
  -DEXCLUDE_ETHERNET=1
  ; Motion sensor exclusions (keep I2C for cardKB)
  -DEXCLUDE_ACCELEROMETER=1
  -DMESHTASTIC_EXCLUDE_POWER_TELEMETRY=1
  -DEXCLUDE_POWER_TELEMETRY=1
  ; Advanced memory savings for fakeTec
  -DMESHTASTIC_EXCLUDE_ENVIRONMENTAL_SENSOR=1
  -DMESHTASTIC_EXCLUDE_MQTT=1
  -DEXCLUDE_MQTT=1
  -DMESHTASTIC_EXCLUDE_RANGETEST=1
  -DMESHTASTIC_EXCLUDE_CANNEDMESSAGES=1
  -DMESHTASTIC_EXCLUDE_STOREFORWARD=1
  -DMESHTASTIC_EXCLUDE_PAXCOUNTER=1
  -DMESHTASTIC_EXCLUDE_ATAK=1
  -DMESHTASTIC_EXCLUDE_NEIGHBORINFO=1
  -DMESHTASTIC_EXCLUDE_DETECTION_SENSOR=1
  -DMESHTASTIC_EXCLUDE_HEALTH=1
  -DMESHTASTIC_EXCLUDE_TRACEROUTE=1
  ; Audio and speaker exclusions (not available on fakeTec)
  -DMESHTASTIC_EXCLUDE_AUDIO=1
  -DEXCLUDE_AUDIO=1
  -DEXCLUDE_RTTTL=1
; Exclude ESP32-specific source files
build_src_filter = 
  ${env:nrf52_promicro_diy_tcxo.build_src_filter}
  -<src/platform/esp32/>
  -<src/nimble/>
  +<../variants/nrf52840/diy/nrf52_promicro_diy_tcxo/StubDefinitions.cpp>
lib_ignore = 
  ${env:nrf52_promicro_diy_tcxo.lib_ignore}
  WiFi
  WebServer
  ESPAsyncWebServer
  DNSServer
  Ethernet
  NimBLE-Arduino
  bsec2
  NonBlockingRTTTL
extra_scripts = 
  ${env:nrf52_promicro_diy_tcxo.extra_scripts}