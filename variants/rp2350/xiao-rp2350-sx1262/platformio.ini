[env:xiao-rp2350-sx1262]
extends = rp2350_base
board = seeed_xiao_rp2350
board_level = extra
upload_protocol = picotool

# Board configuration for XIAO RP2350
board_upload.maximum_size = 2097152     ; 2MB flash (W25Q16)
board_upload.psram_length = 0           ; RP2350 has NO PSRAM
board_build.filesystem_size = 0.5m      ; 512KB for LittleFS

# Variant-specific build flags
build_flags =
  ${rp2350_base.build_flags}
  -D RPI_PICO2
  -D XIAO_RP2350_SX1262
  ;-D XIAO_USB_CAPTURE_ENABLED
  -I variants/rp2350/xiao-rp2350-sx1262
  -I src/platform/rp2xx0/usb_capture
  -D DEBUG_RP2040_PORT=Serial
  -D HW_SPI0_DEVICE
  -D RADIOLIB_SOFTWARE_SERIAL_UNSUPPORTED
  -D ARDUINO_ARCH_RP2040
  ; SDK 5.4.3: FreeRTOS scheduler DISABLED (conflicts with manual Core1 launch)
  ; RP2350 uses std::queue fallback instead (see TypedQueue.h:65-124)
  ; -D PIO_FRAMEWORK_ARDUINO_ENABLE_FREERTOS  ‚Üê Disabled (breaks multicore)

  ; ==================== MULTICORE FLASH SAFETY ====================
  ; CRITICAL: Move ALL Core1 USB capture code to RAM to prevent crashes
  ; during Core0 flash writes. Without this, Core1 crashes trying to execute
  ; from flash when Core0 writes to filesystem (Arduino-Pico limitation).
  -Wl,--wrap=__wrap_flash_flush_cache
  -Wl,--undefined=__isr_vector

  ; ==================== RP2350 LOCKOUT WORKAROUND =================
  ; RP2350 has a FIFO IRQ conflict in multicore lockout mechanism:
  ; - Issue: pico-sdk #2222 (FIFO IRQ number same for both cores)
  ; - Impact: flash_safe_execute() may hang during filesystem writes
  ; - SDK Fix: Scheduled for SDK 2.3.0 (will use doorbells instead)
  ;
  ; Current Workaround (in src/SafeFile.cpp):
  ;   - USE_FIFO_RECOVERY: Send manual LOCKOUT_MAGIC_END via FIFO
  ;   - USE_NUCLEAR_OPTION: Stop/restart Core1 around filesystem ops
  ;
  ; References:
  ;   - https://github.com/raspberrypi/pico-sdk/issues/2222
  ;   - https://github.com/raspberrypi/pico-sdk/issues/2454
  ;   - https://forums.raspberrypi.com/viewtopic.php?t=388734
  ; ================================================================

lib_deps =
  ${rp2350_base.lib_deps}

debug_build_flags = ${rp2350_base.build_flags}, -g
debug_tool = cmsis-dap
