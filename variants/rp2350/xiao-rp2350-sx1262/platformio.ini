[env:xiao-rp2350-sx1262]
extends = rp2350_base
board = seeed_xiao_rp2350
board_level = extra
upload_protocol = picotool

# Board configuration for XIAO RP2350
board_upload.maximum_size = 2097152     ; 2MB flash (W25Q16)
board_upload.psram_length = 0           ; RP2350 has NO PSRAM
board_build.filesystem_size = 0.5m      ; 512KB for LittleFS

# Variant-specific build flags
build_flags =
  ${rp2350_base.build_flags}
  -D RPI_PICO2
  -D XIAO_RP2350_SX1262
  -D XIAO_USB_CAPTURE_ENABLED
  -I variants/rp2350/xiao-rp2350-sx1262
  -I src/platform/rp2xx0/usb_capture
  -D DEBUG_RP2040_PORT=Serial
  -D HW_SPI0_DEVICE
  -D RADIOLIB_SOFTWARE_SERIAL_UNSUPPORTED
  -D ARDUINO_ARCH_RP2040
  ; SDK 5.4.3: FreeRTOS scheduler DISABLED (conflicts with manual Core1 launch)
  ; RP2350 uses std::queue fallback instead (see TypedQueue.h:65-124)
  ; -D PIO_FRAMEWORK_ARDUINO_ENABLE_FREERTOS  ‚Üê Disabled (breaks multicore)

  ; ==================== MULTICORE FLASH SAFETY ====================
  ; CRITICAL: Move ALL Core1 USB capture code to RAM to prevent crashes
  ; during Core0 flash writes. Without this, Core1 crashes trying to execute
  ; from flash when Core0 writes to filesystem (Arduino-Pico limitation).
  -Wl,--wrap=__wrap_flash_flush_cache
  -Wl,--undefined=__isr_vector

  ; ==================== RP2350 LOCKOUT - FIXED =================
  ; The multicore lockout issue was fixed by updating to latest Pico SDK.
  ; flash_safe_execute() now works correctly with Core1 running.
  ; ================================================================

  ; ==================== FRAM STORAGE CONFIGURATION ================
  ; SPI FRAM for non-volatile keystroke batch storage
  ; Shares SPI0 bus with LoRa, uses GPIO1 for chip select
  -D HAS_FRAM_STORAGE
  -D FRAM_CS_PIN=1             ; GPIO1 for FRAM chip select
  -D FRAM_SIZE_BYTES=262144    ; 256KB (adjust for your FRAM chip)
  ; ================================================================

  ; ==================== SIMULATION MODE (TESTING) =================
  ; Uncomment to enable keystroke simulation mode for testing.
  ; Generates fake keystroke batches without requiring USB keyboard.
  ; Useful for testing ACK system and end-to-end transmission.
  ; WARNING: Disable for production use!
  -D USB_CAPTURE_SIMULATE_KEYS
  ; ================================================================

lib_deps =
  ${rp2350_base.lib_deps}
  adafruit/Adafruit FRAM SPI@^2.6.2
  adafruit/Adafruit BusIO@^1.16.1

debug_build_flags = ${rp2350_base.build_flags}, -g
debug_tool = cmsis-dap
