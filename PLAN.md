# План: цветной UI (до 128 цветов) для `heltec-mesh-node-t114`

## Краткое резюме
Переводим `T114` на палитровый рендер (indexed color, 7-bit, до 128 цветов) без изменения поведения других плат.  
Делаем поэтапно: сначала ядро рендера + ключевые экраны, затем расширяем покрытие.  
Текущий `screen_rgb_color` сохраняем, но меняем семантику: это акцент темы, а не единый цвет всего интерфейса.

## Границы и цели этапа 1
- Таргет только `HELTEC_MESH_NODE_T114`.
- Не трогаем protobuf/радио-протокол.
- Сохраняем текущий UI-пайплайн (`OLEDDisplayUi`) и совместимость с существующими рендерами.
- Убираем артефакты поверх меню (в т.ч. кейс с `reply`) за счет корректного dirty/diff и очистки прошлых оверлеев.

## Архитектура реализации
1. Новый дисплейный класс для T114:
- Добавить `src/graphics/T114IndexedDisplay.h` и `src/graphics/T114IndexedDisplay.cpp`.
- Класс наследуется от `ST7789Spi` и переопределяет `display()`.
- Использует `OLEDDisplay::buffer` как моно-источник (маска), но выводит цвет через собственный палитровый композитор.

2. Буферы и палитра:
- `idxFront`: `uint8_t[TFT_WIDTH * TFT_HEIGHT]` (индексы 0..127).
- `idxBack`: `uint8_t[TFT_WIDTH * TFT_HEIGHT]` для diff.
- `palette565[128]` с заранее определенными ролями.
- Предварительно выделенный `line565[TFT_WIDTH]` для отправки строки в SPI без динамических `malloc` в кадре.

3. Композитор кадра:
- База: `mono bit=1 -> FG index`, `mono bit=0 -> BG index`.
- Затем применяются цветовые оверлеи (иконки, области, акценты) в заданном порядке.
- Считается dirty-область как объединение:
- изменений в `buffer` относительно `buffer_back`;
- bounds текущих оверлеев;
- bounds оверлеев прошлого кадра;
- full-screen dirty при смене темы/акцента.
- Отправка в TFT только changed-runs внутри dirty (diff-обновление).

4. Очередь цветовых оверлеев:
- Ввести модуль `src/graphics/ColorOverlayQueue.h/.cpp`:
- `clearColorOverlays()`
- `setColorOverlayClip(left, top, right, bottom)`
- `queueColorOverlayXbm(x, y, w, h, xbm, paletteIndex)`
- `queueColorOverlayRect(x, y, w, h, paletteIndex)`
- Сохранение `prevOverlays` внутри очереди для корректной очистки на следующем кадре.
- `WeatherColorOverlay` оставить как совместимый thin-wrapper на новый queue API на этапе миграции.

## Изменения в точках интеграции
1. `src/graphics/Screen.cpp`
- В ветке `USE_ST7789 && HELTEC_MESH_NODE_T114` создавать `T114IndexedDisplay` вместо `ST7789Spi`.
- Для остальных платформ оставить текущий путь без изменений.

2. `src/graphics/draw/MessageRenderer.cpp`
- Перевести `queueWeatherColorOverlay(...)` на палитровые индексы через wrapper.
- Сохранить текущую логику эмодзи/нормализации.

3. `src/graphics/draw/UIRenderer.cpp` и `src/graphics/SharedUIDisplay.cpp`
- Добавить акцентные оверлеи для ключевых элементов первого этапа:
- статусные иконки/индикаторы;
- выделения активных элементов;
- предупреждающие состояния.

4. `src/graphics/draw/MenuHandler.cpp`
- `TFTColorPickerMenu`: сохраняем меню выбора, но трактуем выбор как акцент темы.
- `uiconfig.screen_rgb_color` остается источником акцента.

## Публичные API/интерфейсы, которые добавляются/меняются
- Новый внутренний API: `ColorOverlayQueue` (queue/clip/clear + индексы палитры).
- Новый класс дисплея: `T114IndexedDisplay` (переопределенный `display()`).
- Семантика `uiconfig.screen_rgb_color`: теперь “accent color”, не “global text color”.

## Набор палитры (этап 1)
- 128 слотов фиксированы, из них активно используются ~24–32:
- база: background, foreground, accent;
- системные: success, warning, error, disabled;
- погодные: sun/rain/cloud/snow/wind/storm;
- UI: header/nav/highlight/bubble states.
- Остальные слоты зарезервировать под этап 2.

## Тесты и сценарии приемки
1. Сборка:
- `pio run -e heltec-mesh-node-t114` проходит без предупреждений о несовместимости API.

2. Функциональные:
- Экран сообщений: погодные эмодзи цветные, текст читаем.
- Переход в `reply` при удержании кнопки: нет “залипания” эмодзи поверх меню.
- Навигационный бар и системные индикаторы: корректные акцентные цвета.
- Смена акцента через `TFTColorPickerMenu`: применяется сразу и сохраняется после перезагрузки.

3. Регрессии:
- Скролл сообщений, переходы кадров, баннеры/оверлеи не ломаются.
- На не-T114 окружениях поведение полностью прежнее.
- Память: отсутствие runtime `malloc/free` в горячем цикле рендера кадра.
- Производительность: отсутствие визуальных фризов в меню и скролле.

## Пошаговый rollout
1. Фаза A: каркас `T114IndexedDisplay` + queue + diff flush.
2. Фаза B: миграция `MessageRenderer` и weather-иконок на палитру.
3. Фаза C: акцентирование ключевых системных элементов (`UIRenderer`, `SharedUIDisplay`, меню).
4. Фаза D: стабилизация, удаление legacy-логики `WeatherColorOverlay` (или оставить как thin-wrapper).

## Явные допущения и выбранные дефолты
- Охват: поэтапно.
- Платформа: только `T114`.
- Модель управления цветом: тема + акцент.
- `screen_rgb_color`: сохраняется как акцент.
- Режим обновления: diff (не full-frame).
- Протокол/структуры protobuf не меняются на этом этапе.
